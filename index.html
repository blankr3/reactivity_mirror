<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactivity Mirror</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background-color: #fff; }
        .wrap { max-width: 720px; margin: 0 auto; padding: 24px 16px; }
        #reactivity-input { width: 100%; box-sizing: border-box; min-height: 200px; background: #f7f7f7; color: #111; border: 1px solid #ccc; border-radius: 8px; padding: 14px; font-size: 16px; line-height: 1.6; resize: vertical; margin-bottom: 16px; }
        .feedback-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px 16px; align-items: center; }
        .gauge-container { grid-row: 1 / 3; position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; }
        .gauge-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .gauge-track, .gauge-value { fill: none; stroke-width: 10; stroke-linecap: round; }
        .gauge-track { stroke: #e5e5e5; }
        .gauge-value { transition: stroke-dashoffset 0.4s ease, stroke 0.4s ease; }
        .gauge-text { position: absolute; text-align: center; }
        .gauge-badge { font-weight: 800; font-size: 18px; transition: color 0.4s ease; }
        .gauge-score { font-size: 14px; color: #777; margin-top: 4px; }
        .coach-output { grid-column: 2 / 3; min-height: 48px; padding: 12px; background: #f7f7f7; border-radius: 8px; }
        .chips-container { grid-column: 2 / 3; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; }
        .chip { font-size: 12px; padding: 4px 10px; border-radius: 99px; background: #eee; color: #333; }
        .coach-output.analyzing { animation: pulsing 1.5s infinite; }
        @keyframes pulsing { 0% { background-color: #eaf2ff; } 50% { background-color: #dbe8ff; } 100% { background-color: #eaf2ff; } }
        .feedback-grid.is-idle .gauge-container, .feedback-grid.is-idle .chips-container { opacity: 0.35; transition: opacity 0.3s ease; }
        .progress-container { grid-column: 1 / -1; width: 100%; height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden; margin-top: 8px;}
        .progress-bar { width: 0%; height: 100%; background: #4a90e2; transition: width 0.1s linear; }
    </style>
</head>
<body>
    <div class="wrap">
        <textarea id="reactivity-input" placeholder="Please wait, AI engine is loading..." disabled></textarea>
        <div class="feedback-grid">
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 120 120">
                    <circle class="gauge-track" cx="60" cy="60" r="52" />
                    <circle id="gauge-value" class="gauge-value" cx="60" cy="60" r="52" stroke-dasharray="326.7" stroke-dashoffset="326.7" stroke="#00E091" />
                </svg>
                <div class="gauge-text">
                    <div id="gauge-badge" class="gauge-badge">CALM</div>
                    <div id="gauge-score" class="gauge-score">0%</div>
                </div>
            </div>
            <div id="coach-output" class="coach-output">Waiting for input...</div>
            <div id="chips-container" class="chips-container"></div>
            <div id="progress-container" class="progress-container" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
        </div>
    </div>

    <script type="module">
        const SCRIPT_CONFIG = {
            model: "TinyLlama-1.1B-Chat-v0.4-q4f32_1-MLC",
            debounceDelay: 300, EMA_ALPHA_MIN: 0.15, EMA_ALPHA_MAX: 0.7, LARGE_CHANGE_THRESHOLD: 50,
            systemPrompt: `You are an expert text analyzer. Your response MUST be ONLY a single, minified JSON object with two keys: "reactive_score" (a number from 0.0 to 1.0) and "triggers" (an array of strings). Example: {"reactive_score":0.8,"triggers":["blame"]}`,
        };
        const D = { textInput: document.getElementById('reactivity-input'), feedbackGrid: document.querySelector('.feedback-grid'), gaugeValue: document.getElementById('gauge-value'), gaugeBadge: document.getElementById('gauge-badge'), gaugeScore: document.getElementById('gauge-score'), coachOutput: document.getElementById('coach-output'), chipsContainer: document.getElementById('chips-container'), progressContainer: document.getElementById('progress-container'), progressBar: document.getElementById('progress-bar') };
        let typingTimer;
        const circumference = 326.7;

        function updateGauge(score) { if (score < 0.15) { score = 0; } const p=Math.round(score*100),o=circumference*(1-score);let c='#00E091',b='CALM';if(score>=0.8){c='#d90429';b='CRITICAL';}else if(score>=0.6){c='#FF5A5A';b='HIGH';}else if(score>=0.4){c='#FFC700';b='MEDIUM';}else if(score>=0.2){c='#76c893';b='LOW';}D.gaugeValue.style.strokeDashoffset=o;D.gaugeValue.style.stroke=c;D.gaugeBadge.textContent=b;D.gaugeBadge.style.color=c;D.gaugeScore.textContent=`${p}%`;};
        function updateChips(triggers = []) { D.chipsContainer.innerHTML='';triggers.slice(0,4).forEach(t=>{const c=document.createElement('div');c.className='chip';c.textContent=t;D.chipsContainer.appendChild(c);});};
        function updateCoaching(score, triggers = []) {const s=new Set(triggers.map(t=>t.toLowerCase()));let c="Notice the body breathing.";if(score>=0.7)c=s.has("blame")?"Pause. Three slow breaths.":"Soften shoulders.";else if(score>=0.4)c=s.has("urgency")?"Is this truly urgent? One slower breath.":"Unclench the jaw.";D.coachOutput.textContent=c;};
        function resetUI(message='Initializing...') { updateGauge(0); updateChips([]); D.coachOutput.textContent=message; D.feedbackGrid.classList.add('is-idle'); D.progressContainer.style.display='none'; D.progressBar.style.width='0%';}

        if (window.Worker) {
            resetUI('Starting worker...');
            const worker = new Worker('./worker.js', { type: 'module' });
            worker.postMessage({ type: 'INITIALIZE', config: SCRIPT_CONFIG });

            D.textInput.addEventListener('input', () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    const text = D.textInput.value;
                    if (!text.trim()) { resetUI('Model ready.'); return; }
                    D.feedbackGrid.classList.remove('is-idle');
                    D.coachOutput.classList.add('analyzing');
                    D.coachOutput.textContent = '...'; // Placeholder while worker thinks
                    worker.postMessage({type: 'ANALYZE', text: text});
                }, SCRIPT_CONFIG.debounceDelay);
            });

            worker.onmessage = (event) => {
                const { type, payload, text, percentage } = event.data;
                D.coachOutput.classList.remove('analyzing');

                if (type === 'STATUS') {
                    D.progressContainer.style.display = 'none';
                    D.coachOutput.textContent = text;
                } else if (type === 'DOWNLOAD_PROGRESS') {
                    D.progressContainer.style.display = 'block';
                    D.coachOutput.textContent = text;
                    D.progressBar.style.width = `${percentage}%`;
                } else if (type === 'READY') {
                    D.progressContainer.style.display = 'none';
                    resetUI('Model ready.');
                    D.textInput.disabled = false;
                    D.textInput.placeholder = "Type what you're about to send...";
                } else if (type === 'RESULT') {
                    const { smoothedScore, triggers, isLargeChange } = payload;
                    if(isLargeChange) D.coachOutput.textContent = "Wow, big change! Digesting...";
                    updateGauge(smoothedScore);
                    updateChips(triggers);
                    updateCoaching(smoothedScore, triggers);
                } else if (type === 'ERROR') {
                    D.coachOutput.textContent = text;
                } else if (type === 'NO_OP') {
                    // Do nothing, text was the same
                }
            };
        } else {
            D.coachOutput.textContent = "Web Workers are not supported in this browser.";
        }
    </script>
</body>
</html>