<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactivity Mirror</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background-color: #fff; }
        .wrap { max-width: 720px; margin: 0 auto; padding: 24px 16px; }
        #reactivity-input { width: 100%; box-sizing: border-box; min-height: 200px; background: #f7f7f7; color: #111; border: 1px solid #ccc; border-radius: 8px; padding: 14px; font-size: 16px; line-height: 1.6; resize: vertical; margin-bottom: 16px; }
        .feedback-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px 16px; align-items: center; }
        .gauge-container { grid-row: 1 / 3; position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; }
        .gauge-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .gauge-track, .gauge-value { fill: none; stroke-width: 10; stroke-linecap: round; }
        .gauge-track { stroke: #e5e5e5; }
        .gauge-value { transition: stroke-dashoffset 0.4s ease, stroke 0.4s ease; }
        .gauge-text { position: absolute; text-align: center; }
        .gauge-badge { font-weight: 800; font-size: 18px; transition: color 0.4s ease; }
        .gauge-score { font-size: 14px; color: #777; margin-top: 4px; }
        .coach-output { grid-column: 2 / 3; min-height: 48px; padding: 12px; background: #f7f7f7; border-radius: 8px; }
        .chips-container { grid-column: 2 / 3; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; }
        .chip { font-size: 12px; padding: 4px 10px; border-radius: 99px; background: #eee; color: #333; }
        .coach-output.analyzing { animation: pulsing 1.5s infinite; }
        @keyframes pulsing { 0% { background-color: #eaf2ff; } 50% { background-color: #dbe8ff; } 100% { background-color: #eaf2ff; } }
        .feedback-grid.is-idle .gauge-container, .feedback-grid.is-idle .chips-container { opacity: 0.35; transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div class="wrap">
        <textarea id="reactivity-input" placeholder="Type to begin analysis..."></textarea>
        <div class="feedback-grid is-idle">
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 120 120">
                    <circle class="gauge-track" cx="60" cy="60" r="52" />
                    <circle id="gauge-value" class="gauge-value" cx="60" cy="60" r="52" stroke-dasharray="326.7" stroke-dashoffset="326.7" stroke="#00E091" />
                </svg>
                <div class="gauge-text">
                    <div id="gauge-badge" class="gauge-badge">CALM</div>
                    <div id="gauge-score" class="gauge-score">0%</div>
                </div>
            </div>
            <div id="coach-output" class="coach-output">Waiting for input...</div>
            <div id="chips-container" class="chips-container"></div>
        </div>
    </div>

    <script type="module">
        const SCRIPT_CONFIG = {
            API_URL: "https://ronblank-reactivity-mirror-backend.hf.space",
            DEBOUNCE_DELAY: 300, EMA_ALPHA_MIN: 0.15, EMA_ALPHA_MAX: 0.7, LARGE_CHANGE_THRESHOLD: 50,
        };
        const D = { textInput: document.getElementById('reactivity-input'), feedbackGrid: document.querySelector('.feedback-grid'), gaugeValue: document.getElementById('gauge-value'), gaugeBadge: document.getElementById('gauge-badge'), gaugeScore: document.getElementById('gauge-score'), coachOutput: document.getElementById('coach-output'), chipsContainer: document.getElementById('chips-container') };
        let smoothedScore = 0, lastAnalyzedText = '', typingTimer;
        const circumference = 326.7;

        function updateGauge(score) { if (score < 0.15) { score = 0; } const p=Math.round(score*100),o=circumference*(1-score);let c='#00E091',b='CALM';if(score>=0.8){c='#d90429';b='CRITICAL';}else if(score>=0.6){c='#FF5A5A';b='HIGH';}else if(score>=0.4){c='#FFC700';b='MEDIUM';}else if(score>=0.2){c='#76c893';b='LOW';}D.gaugeValue.style.strokeDashoffset=o;D.gaugeValue.style.stroke=c;D.gaugeBadge.textContent=b;D.gaugeBadge.style.color=c;D.gaugeScore.textContent=`${p}%`;};
        function updateChips(triggers = []) { D.chipsContainer.innerHTML='';triggers.slice(0,4).forEach(t=>{const c=document.createElement('div');c.className='chip';c.textContent=t;D.chipsContainer.appendChild(c);});};
        function updateCoaching(score, triggers = []) {const s=new Set(triggers.map(t=>t.toLowerCase()));let c="Notice the body breathing.";if(score>=0.7)c=s.has("accusation")?"Focus on 'I' statements.":"Soften shoulders.";else if(score>=0.4)c="Is this truly urgent? One slower breath.";D.coachOutput.textContent=c;};
        function resetUI() { smoothedScore = 0; lastAnalyzedText = ''; updateGauge(0); updateChips([]); D.coachOutput.textContent='Waiting for input...'; D.feedbackGrid.classList.add('is-idle'); }
        function levenshtein(a,b){const m=Array(b.length+1).fill(null).map(()=>Array(a.length+1).fill(null));for(let i=0;i<=a.length;i+=1){m[0][i]=i;}for(let j=0;j<=b.length;j+=1){m[j][0]=j;}for(let j=1;j<=b.length;j+=1){for(let i=1;i<=a.length;i+=1){const ind=a[i-1]===b[j-1]?0:1;m[j][i]=Math.min(m[j][i-1]+1,m[j-1][i]+1,m[j-1][i-1]+ind);}}return m[b.length][a.length];}

        async function analyze() {
            const normalizedText = D.textInput.value.trim();
            if (normalizedText === lastAnalyzedText) return;
            if (!normalizedText) { resetUI(); return; }

            D.feedbackGrid.classList.remove('is-idle');
            D.coachOutput.classList.add('analyzing');
            D.coachOutput.textContent = '...';

            try {
                if (!SCRIPT_CONFIG.API_URL.startsWith('http')) throw new Error("API_URL is not configured.");

                const response = await fetch(`${SCRIPT_CONFIG.API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: normalizedText })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const result = await response.json();
                const distance = levenshtein(lastAnalyzedText, normalizedText);
                const isLargeChange = distance > SCRIPT_CONFIG.LARGE_CHANGE_THRESHOLD || lastAnalyzedText === '';
                let dynamicAlpha = isLargeChange ? 1.0 : SCRIPT_CONFIG.EMA_ALPHA_MIN + (SCRIPT_CONFIG.EMA_ALPHA_MAX - SCRIPT_CONFIG.EMA_ALPHA_MIN) * Math.min(distance / SCRIPT_CONFIG.LARGE_CHANGE_THRESHOLD, 1.0);

                lastAnalyzedText = normalizedText;
                const currentScore = Math.max(0, Math.min(1, result.reactive_score));
                smoothedScore = (dynamicAlpha * currentScore) + (1 - dynamicAlpha) * smoothedScore;

                updateGauge(smoothedScore);
                updateChips(result.triggers);
                updateCoaching(smoothedScore, result.triggers);

            } catch (error) {
                console.error("Analysis failed:", error);
                D.coachOutput.textContent = 'Analysis service unavailable.';
            } finally {
                D.coachOutput.classList.remove('analyzing');
            }
        }

        D.textInput.addEventListener('input', () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(analyze, SCRIPT_CONFIG.DEBOUNCE_DELAY);
        });
        resetUI();
    </script>
</body>
</html>
